# 마을 출석 현황 조회 버그 수정

## 장애 개요

- **날짜**: 2025-05-06
- **영향받은 기능**: `/api/village/{id}/attendance` API (마을 출석 현황 조회)
- **증상**: 마을 ID가 2인 마을의 출석 현황을 조회했을 때 빈 리스트가 반환되며, 실제로는 해당 마을에 속한 GBS 그룹들의 출석 데이터가 있음에도 불구하고 조회되지 않는 현상

## 원인 분석

1. `AttendanceService.getVillageAttendance` 메소드에서 GBS 그룹을 조회할 때 현재 날짜(`LocalDate.now()`)를 기준으로 활성화된 GBS 그룹만 조회하고 있었음
2. 과거 날짜(예: 2023-01-08)의 출석 데이터를 조회하려고 해도, 현재 날짜(2025-05-06)에 활성화된 GBS 그룹만 필터링되어, 해당 시점의 GBS 그룹 구성이 조회되지 않음
3. 마찬가지로 `createGbsAttendanceSummary` 메소드에서도 GBS 멤버 수와 리더 정보를 조회할 때 현재 날짜를 기준으로 하여 과거 데이터와 일치하지 않는 정보가 제공됨

## 해결 방안

1. GBS 그룹 조회 기준 날짜 변경
   - `AttendanceService.getVillageAttendance` 메소드에서 현재 날짜(`LocalDate.now()`) 대신 요청된 날짜(`weekStart`)를 기준으로 활성화된 GBS 그룹을 조회하도록 수정

2. 해당 날짜 기준의 리더 정보 조회 구현
   - `GbsLeaderHistoryRepositoryCustom` 인터페이스에 특정 날짜에 활성화된 리더를 찾는 `findLeaderByGbsIdAndDate` 메소드 추가
   - `GbsLeaderHistoryRepositoryImpl`에서 해당 메소드 구현
   - 리더 조회 시 특정 날짜를 기준으로 활성화된 리더(시작일 <= 기준일 && (종료일 == null || 종료일 >= 기준일))를 조회

3. `createGbsAttendanceSummary` 메소드 수정
   - GBS 리더 조회 시 현재 리더 대신 해당 날짜(`referenceDate`)의 리더를 찾도록 수정
   - GBS 멤버 수 조회 시 현재 날짜 대신 해당 날짜(`referenceDate`)의 멤버 수를 조회하도록 수정

## 교훈 및 향후 개선점

1. 시간에 따라 변하는 데이터(조직 구조, 멤버십 등)를 다룰 때는 항상 기준 날짜를 명확히 하고, 해당 날짜 기준의 데이터를 조회하는 로직을 일관되게 적용해야 함
2. 과거 데이터 조회 시 현재 상태를 기준으로 하지 않도록 주의해야 함
3. 비슷한 패턴이 다른 곳에도 존재할 가능성이 있으므로, 다른 통계/조회 관련 기능들도 동일한 관점에서 검토할 필요가 있음
4. 통계/조회 기능에 대한 테스트를 강화하여 시간에 따른 데이터 변화를 고려한 테스트 케이스를 추가할 필요가 있음 